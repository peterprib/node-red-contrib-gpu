<script type="text/javascript">
	/*globals RED */
	RED.nodes.registerType('gpunode', {
		category: 'function',
		color: '#fdeea2',
		defaults: {
			name: {value: ""},
			action: {value:"arrayAdd",required:true},
			blocksProperty:{value:"1"},
			columnsProperty:{value:""},
			columnsPropertyValid:{value:true,validate:(v)=>v},
			hasSecondArgument:{value:false},
			hasColumns:{value:false},
			pipeline:{value:false},
			source1Property:{value:"msg.payload"},
			source2Property:{value:"msg.payload"},
			targetProperty:{value:"msg.payload"}
		},
		inputs: 1,
		outputs: 3,
		icon: "fontawesome/fa-cubes",
		align: 'left',
		paletteLabel: "gpu",
		inputLabels: "Message In",
		outputLabels: ["Message Out","Error","No GPU"],
		label: function () {
			return this.name ||this.action|| "GPU";
		},
		oneditprepare: function() {
			let node=this;
			const operands2=["arrayAdd","arrayMinus","arrayMultiply","arrayDivide","arrayRemainder","arrayPower","arrayBitwiseAnd","arrayBitwiseOr","arrayBitwiseXOR","arrayLeftShift","arrayRightShift","arrayRightShiftZeroFill","matrixMultiple"];
			const operandsColumns=["loadRows","loadColumns","matrixNormsRows","matrixNormsColumns","matrixVarianceRows","matrixVarianceColumns","matrixCorrelationRows","matrixCorrelationColumns","matrixCovarianceRows","matrixCovarianceColumns"];

			$("#node-input-action").change(function() {
				node.hasSecondArgument=operands2.includes($(this).val());
				node.hasColumns=operandsColumns.includes($(this).val());
				$(".form-row-http-in-source2Property")[node.hasSecondArgument?"show":"hide"]();
				$(".form-row-http-in-columns")[node.hasColumns?"show":"hide"]();
			}).change();
			$("#node-input-columnsProperty").change(function() {
				node.columnsPropertyValid=true;
				$(this).css({"background-color":"white"});
				if(!node.hasColumns) return;
				try{
					const value=$(this).val()
					if(value=="") return;
					if(value.startsWith("[")) {
						const test=JSON.parse(value);
						if(!Array.isArray(test)) throw Error("expected valid JSON array");
						if(test.find(c=>!(Number.isInteger(c)&&c>=0))) throw Error("No a positive integer");
						return;
 					} 
 					if(value.startsWith("msg.")) return;
					throw Error("if detailed must start with [ or msg.");
				} catch(ex) {
					console.warn(ex.message);
					$(this).css({"background-color":"red"});
					node.columnsPropertyValid=false;
				}
			}).change();
		},
		oneditsave: function() {
		},
		oneditresize: function() {
		},
		resizeRule: function(file,newWidth) {
		}
	});
</script>

<script type="text/x-red" data-template-name="gpunode">

	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-tag"></i> Name </label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row form-row-http-in-source1Property show">
		<label for="node-input-source1Property" style="white-space: nowrap"><i class="icon-bookmark"></i> Argument 1</label>
		<input type="text" id="node-input-source1Property" placeholder="msg.payload">
	</div>
	<div class="form-row form-row-http-in-source2Property show">
		<label for="node-input-source2Property" style="white-space: nowrap"><i class="icon-bookmark"></i> Argument 2</label>
		<input type="text" id="node-input-source2Property" placeholder="msg.payload">
	</div>
	<div class="form-row form-row-http-in-targetProperty show">
		<label for="node-input-targetProperty" style="white-space: nowrap"><i class="icon-bookmark"></i> Target Property </label>
		<input type="text" id="node-input-targetProperty" placeholder="msg.payload">
	</div>

	<div class="form-row">
		<label for="node-input-action"><i class="fa fa-list-ul"></i> Function </label>
		<select id="node-input-action" placeholder="action">
			<option value="arrayAdd">Add Array</option>
			<option value="matrixAvgRows"			>Average Rows</option>
			<option value="matrixAvgColumns"		>Average Columns</option>
			<option value="arrayBitwiseAnd"			>Bitwise And Array</option>
			<option value="arrayBitwiseOr"			>Bitwise Or Array</option>
			<option value="arrayBitwiseXOR"			>Bitwise XOR Array</option>
			<option value="matrixCorrelationRows"	>Correlation Rows Matrix</option>
			<option value="matrixCorrelationColumns">Correlation Columns Matrix</option>
			<option value="matrixCovarianceRows"	>Covariance Rows Matrix</option>
			<option value="matrixCovarianceColumns"	>Covariance Columns Matrix</option>
			<option value="arrayDivide"				>Divide Array/option>
 			<option value="imageToArray"			>Image To Array</option> 
			<option value="arrayLeftShift"			>Left Shift Array</option>
			<option value="loadColumns"				>Load Array</option>
			<option value="loadRows"				>Load Specific Rows</option>
			<option value="matrixMultiple"			>Matrix Multiple Arrays</option>
			<option value="matrixMomentsRows"		>Moments Rows</option>
			<option value="matrixMomentsColumns"	>Moments Columns</option>
			<option value="arrayMultiply"			>Mulptiply Array</option>
			<option value="matrixNormsRows"			>Norms Rows</option>
			<option value="matrixNormsColumns"		>Norms Columns</option>
			<option value="arrayPower"				>Power Array</option>
			<option value="matrixRangeRows"			>Range Rows</option>
			<option value="matrixRangeColumns"		>Range Columns</option>
			<option value="arrayRemainder"			>Remainder Array</option>
			<option value="matrixStatsRows"			>Stats Rows</option>
			<option value="matrixStatsColumns"		>Stats Columns</option>
			<option value="arrayMinus"				>Substract Array</option>
			<option value="matrixSumRows"			>Sum Rows</option>
			<option value="matrixSumColumns"		>Sum Columns</option>
			<option value="arrayRightShift"			>Right Shift Array</option>
			<option value="arrayRightShiftZeroFill"	>Right Shift Zero Fill Array</option>
			<option value="matrixTranspose"			>Transpose Matrix</option>
			<option value="matrixVarianceRows"		>Variance Rows</option>
			<option value="matrixVarianceColumns"	>Variance Columns</option>
		</select>
	</div>
	<div class="form-row form-row-http-in-columns show">
		<label for="node-input-columnsProperty" style="white-space: nowrap"><i class="icon-bookmark"></i> Column List </label>
		<input type="text" id="node-input-columnsProperty" placeholder="msg.payload">
	</div>
	<div class="form-row">
		<input type="checkbox" id="node-input-pipeline" style="display: inline-block; width: auto; vertical-align: top;">
		<label for="node-input-pipeline" style="width: auto">Pipeline</label>
 	</div>
	<div class="form-row form-row-http-in-blocksProperty show">
		<label for="node-input-blocksProperty" style="white-space: nowrap"><i class="icon-bookmark"></i> Blocks</label>
		<input type="text" id="node-input-blocksProperty" placeholder="1">
	</div>

</script>

<script type="text/x-red" data-help-name="gpunode">
	<p>
	Checks to see if a GPU is available on system and provides functions that work off an array or image.
	Its use only becomes effective on large arrays due to the overheads
	</p>
	<p>
	Source/Target/Topic/Columns allows the override of the property to an expression which can reference RED, node or msg variables.
	</p>
	<p>
	Array must have form [1,2,3], [[1,2],[3,4]] or [[[1,2],[3,4]],[[5,6],[7,8]]
	</p>
	<p>
	Column list appears for actions that allow specific columns to be selected such as correlation.
	</p>
	<p>
	Pipeline allows values to be piped from one node to another to avoid overhead of loading and unloading GPU  
	</p>
	<p>
	Blocks allows an array to be broken into another dimension.  Has perforance benefits plus handling normalised arays.  
	</p>
	<h3>Inputs</h3>
	<dl class="message-properties">
		<dt>msg <span class="property-type">topic</span></dt>
		<dd>incoming message with topic</dd>
		<dt>msg <span class="property-type">payload</span></dt>
		<dd></dd>
	</dl>
	<h3>Ports</h3>
	<dl class="message-properties">
		<dt><span class="property-type">msg out</span></dt>
		<dd>a message where msg.error details error during processing</dd>
		<dt><span class="property-type">error</span></dt>
		<dd>a message where msg.error details error during processing</dd>
		<dt><span class="property-type">no gpu</span></dt>
		<dd>Allow a flow to be built that will work if no GPU existss</dd>

	</dl>
</script>